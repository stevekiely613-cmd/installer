name: Create Portable VSD
on: workflow_dispatch

jobs:
  build_portable:
    runs-on: windows-latest
    steps:
      # 1. Download the installer directly to the runner
      - name: Download Installer
        run: Invoke-WebRequest -Uri "https://cdn.vsdinside.com/shopify_VSD/VSD-Craft-Installer_Windows.exe" -OutFile "vsd_setup.exe"

      # 2. Run the installer silently
      # We use -Wait to ensure it finishes before we look for files
      - name: Install Silently
        run: Start-Process -FilePath ".\vsd_setup.exe" -ArgumentList "/S" -Wait

      # 3. Hunt down the installed folder (Deep Search)
      - name: Locate and Zip Folder
        run: |
          Write-Host "Searching for VSD installation..."
          
          # List of likely hiding spots for Windows apps
          $likelyPaths = @(
            "C:\Program Files",
            "C:\Program Files (x86)",
            "$env:LOCALAPPDATA",
            "$env:APPDATA"
          )
          
          $foundPath = $null

          # check standard paths first
          foreach ($path in $likelyPaths) {
            if (Test-Path $path) {
               $match = Get-ChildItem -Path $path -Filter "*VSD*" -Recurse -Depth 2 -ErrorAction SilentlyContinue | Where-Object { $_.PSIsContainer } | Select-Object -First 1
               if ($match) {
                 $foundPath = $match.FullName
                 break
               }
            }
          }
          
          # If not found, panic and search the ENTIRE C: drive (takes a moment)
          if (-not $foundPath) {
             Write-Host "Not found in standard paths. Scanning entire C: drive..."
             $match = Get-ChildItem -Path "C:\" -Filter "*VSD*" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.PSIsContainer } | Select-Object -First 1
             if ($match) { $foundPath = $match.FullName }
          }

          # Zip the result if found
          if ($foundPath) {
             Write-Host "FILES FOUND AT: $foundPath"
             Compress-Archive -Path "$foundPath\*" -DestinationPath "vsd_portable.zip"
          } else {
             Write-Error "Could not find installation folder! The installer might have failed or used a strange name."
             exit 1
          }

      # 4. Upload the zip so you can download it
      - name: Upload Portable Zip
        uses: actions/upload-artifact@v4
        with:
          name: VSD_Portable_Files
          path: vsd_portable.zip
