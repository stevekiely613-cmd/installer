name: Create Portable VSD (Fix)
on: workflow_dispatch

jobs:
  build_portable:
    runs-on: windows-latest
    steps:
      - name: Download Installer
        run: Invoke-WebRequest -Uri "https://cdn.vsdinside.com/shopify_VSD/VSD-Craft-Installer_Windows.exe" -OutFile "vsd_setup.exe"

      - name: Install with Inno Setup Flags
        timeout-minutes: 5  # Stop if it gets stuck
        run: |
          Write-Host "Attempting install with /VERYSILENT /NORESTART..."
          # Try the Inno Setup flags first
          $process = Start-Process -FilePath ".\vsd_setup.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -PassThru
          $process.WaitForExit(300000) # Wait up to 5 minutes

          if (-not $process.HasExited) {
              Write-Host "Installer stuck! Killing process..."
              Stop-Process -Id $process.Id -Force
              
              # If that failed, try the NSIS flag one last time with a kill-switch
              Write-Host "Retrying with /S (NSIS mode)..."
              Start-Process -FilePath ".\vsd_setup.exe" -ArgumentList "/S" -Wait
          }

      - name: Locate and Zip Folder
        run: |
          $likelyPaths = @(
            "C:\Program Files",
            "C:\Program Files (x86)",
            "$env:LOCALAPPDATA",
            "$env:APPDATA"
          )
          
          $foundPath = $null

          foreach ($path in $likelyPaths) {
            if (Test-Path $path) {
               $match = Get-ChildItem -Path $path -Filter "*VSD*" -Recurse -Depth 2 -ErrorAction SilentlyContinue | Where-Object { $_.PSIsContainer } | Select-Object -First 1
               if ($match) {
                 $foundPath = $match.FullName
                 break
               }
            }
          }
          
          if (-not $foundPath) {
             Write-Host "Searching entire C: drive (Fast Mode)..."
             # Limited depth search to avoid 20-minute hangs
             $match = Get-ChildItem -Path "C:\" -Filter "*VSD*" -Recurse -Depth 4 -ErrorAction SilentlyContinue | Where-Object { $_.PSIsContainer } | Select-Object -First 1
             if ($match) { $foundPath = $match.FullName }
          }

          if ($foundPath) {
             Write-Host "FILES FOUND AT: $foundPath"
             Compress-Archive -Path "$foundPath\*" -DestinationPath "vsd_portable.zip"
          } else {
             Write-Error "Could not find installation folder. The installer may have failed silently."
             exit 1
          }

      - name: Upload Portable Zip
        uses: actions/upload-artifact@v4
        with:
          name: VSD_Portable_Files
          path: vsd_portable.zip
