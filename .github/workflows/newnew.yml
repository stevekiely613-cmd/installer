name: Extract VSD (Ripper Mode)
on: workflow_dispatch

jobs:
  rip_files:
    runs-on: windows-latest
    steps:
      - name: Download Installer
        run: Invoke-WebRequest -Uri "https://cdn.vsdinside.com/shopify_VSD/VSD-Craft-Installer_Windows.exe" -OutFile "vsd_setup.exe"

      - name: Rip Files with 7-Zip
        run: |
          # 7-Zip is pre-installed on GitHub Runners. We use it to open the exe as an archive.
          # -y = yes to all prompts
          # -o = output directory
          
          Write-Host "Attempting extraction with 7-Zip..."
          & "C:\Program Files\7-Zip\7z.exe" x "vsd_setup.exe" -o"extracted_vsd" -y
          
          if (Test-Path "extracted_vsd") {
              Write-Host "Extraction Successful!"
              Get-ChildItem "extracted_vsd"
          } else {
              Write-Error "7-Zip failed to open the file."
              exit 1
          }

      - name: Clean up specific folders
        # Some installers extract weird internal files. We rename the main folder to make it clear.
        run: |
          if (Test-Path "extracted_vsd\$_OUTDIR") {
              Write-Host "Found standard output directory. Renaming..."
              Move-Item "extracted_vsd\$_OUTDIR" "extracted_vsd\VSD_Program_Files"
          }

      - name: Zip the Result
        run: Compress-Archive -Path "extracted_vsd\*" -DestinationPath "vsd_portable.zip"

      - name: Upload Portable Zip
        uses: actions/upload-artifact@v4
        with:
          name: VSD_Portable_Files
          path: vsd_portable.zip
